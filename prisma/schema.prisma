// Prisma schema for County Subscription Availability Checker
// Generated from existing database structure

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users Table (for application users)
model User {
  id                Int            @id @default(autoincrement()) @map("user_id")
  email             String         @unique @db.VarChar(255)
  passwordHash      String         @map("password_hash") @db.VarChar(255)
  firstName         String?        @map("first_name") @db.VarChar(100)
  lastName          String?        @map("last_name") @db.VarChar(100)
  phone             String?        @unique @db.VarChar(50)
  address           String?
  stripeCustomerId  String?        @unique @map("stripe_customer_id") @db.VarChar(255)
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)

  // PLG (Product-Led Growth) fields
  credits           Int            @default(0)
  userType          String         @default("standard") @map("user_type") @db.VarChar(50) // "standard" | "free_claim"
  hasUsedFreeTrial  Boolean        @default(false) @map("has_used_free_trial")

  subscriptions      Subscription[]
  claimedAuctions    ClaimedAuction[]
  creditTransactions CreditTransaction[]
  passwordResetTokens UserPasswordResetToken[]

  @@map("users")
}

// User Password Reset Tokens Table
model UserPasswordResetToken {
  id        Int       @id @default(autoincrement()) @map("token_id")
  userId    Int       @map("user_id")
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("user_password_reset_tokens")
}

// NextAuth Tables
model Account {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refreshToken      String?  @map("refresh_token")
  accessToken       String?  @map("access_token")
  expiresAt         Int?     @map("expires_at")
  tokenType         String?  @map("token_type")
  scope             String?
  idToken           String?  @map("id_token")
  sessionState      String?  @map("session_state")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("sessions")
}

// Admin Tables
model AdminUser {
  id           Int                  @id @default(autoincrement()) @map("admin_id")
  username     String               @unique @db.VarChar(50)
  email        String               @unique @db.VarChar(100)
  passwordHash String               @map("password_hash") @db.VarChar(255)
  fullName     String               @map("full_name") @db.VarChar(100)
  role         String               @default("admin") @db.VarChar(20)
  isActive     Boolean              @default(true) @map("is_active")
  createdAt    DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLogin    DateTime?            @map("last_login") @db.Timestamptz(6)
  activityLogs AdminActivityLog[]
  passwordResetTokens PasswordResetToken[]

  @@map("admin_users")
}

model AdminActivityLog {
  id         Int       @id @default(autoincrement()) @map("log_id")
  adminId    Int?      @map("admin_id")
  action     String    @db.VarChar(100)
  tableName  String?   @map("table_name") @db.VarChar(50)
  recordId   Int?      @map("record_id")
  oldValues  Json?     @map("old_values")
  newValues  Json?     @map("new_values")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  admin      AdminUser? @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_activity_log")
}

// Password Reset Tokens Table
model PasswordResetToken {
  id        Int       @id @default(autoincrement()) @map("token_id")
  adminId   Int       @map("admin_id")
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  admin     AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([adminId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// States Table
model State {
  id           Int      @id @default(autoincrement()) @map("state_id")
  name         String   @db.VarChar(100)
  abbreviation String   @unique @db.Char(2)
  counties     County[]

  @@map("states")
}

// Counties Table
model County {
  id                  Int                  @id @default(autoincrement()) @map("county_id")
  name                String               @db.VarChar(100)
  stateId             Int                  @map("state_id")
  status              String               @default("available") @db.VarChar(20)
  population          Int?                 @default(0) // For tiering (Rural/Suburban/Urban)
  freeTrialCount      Int                  @default(0) @map("free_trial_count") // Track # of free trials used (max 5)

  state               State                @relation(fields: [stateId], references: [id], onDelete: Cascade)
  subscriptions       Subscription[]
  trialRegistration   TrialRegistration?
  auctions            Auction[]
  zipCodes            ZipCode[]

  @@index([stateId])
  @@index([status])
  @@map("counties")
}

// Zip Codes Table (for mapping URL/Zip to County)
model ZipCode {
  id        Int      @id @default(autoincrement()) @map("zip_id")
  code      String   @unique @db.VarChar(10)
  countyId  Int      @map("county_id")
  county    County   @relation(fields: [countyId], references: [id], onDelete: Cascade)

  @@index([code])
  @@map("zip_codes")
}

// Offers Table
model Offer {
  id              Int            @id @default(autoincrement()) @map("offer_id")
  name            String         @db.VarChar(100)
  description     String?
  price           Decimal        @db.Decimal(10, 2)
  tierLevel       Int            @map("tier_level")
  stripePriceId   String?        @unique @map("stripe_price_id") @db.VarChar(255)
  stripeProductId String?        @unique @map("stripe_product_id") @db.VarChar(255)
  subscriptions   Subscription[]

  @@map("offers")
}

// Subscriptions Table
model Subscription {
  id                     Int       @id @default(autoincrement()) @map("subscription_id")
  userId                 Int       @map("user_id")
  countyId               Int       @map("county_id")
  offerId                Int       @map("offer_id")
  startDate              DateTime  @map("start_date") @db.Date
  endDate                DateTime  @map("end_date") @db.Date
  status                 String    @default("active") @db.VarChar(20)
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id") @db.VarChar(255)
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end") @db.Timestamptz(6)
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  county                 County    @relation(fields: [countyId], references: [id], onDelete: Cascade)
  offer                  Offer     @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([countyId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

// Trial Registrations Table
model TrialRegistration {
  id              Int      @id @default(autoincrement()) @map("trial_registration_id")
  countyId        Int      @unique @map("county_id")
  email           String   @db.VarChar(255)
  firstName       String   @map("first_name") @db.VarChar(100)
  lastName        String   @map("last_name") @db.VarChar(100)
  phone           String   @db.VarChar(50)
  address         String
  bidsquireUserId String?  @map("bidsquire_user_id") @db.VarChar(255)
  registrationDate DateTime @default(now()) @map("registration_date") @db.Timestamptz(6)
  status          String   @default("active") @db.VarChar(20)
  county          County   @relation(fields: [countyId], references: [id], onDelete: Cascade)

  @@index([countyId])
  @@index([email])
  @@index([status])
  @@map("trialregistrations")
}

// Auctions Table (for PLG auction claiming)
model Auction {
  id                Int              @id @default(autoincrement()) @map("auction_id")
  externalAuctionId String           @unique @map("external_auction_id") @db.VarChar(255) // Extracted from URL (e.g. "695380")
  url               String           @db.VarChar(500)
  title             String?          @db.VarChar(500)
  countyId          Int              @map("county_id")
  zipCode           String?          @map("zip_code") @db.VarChar(20)
  itemCount         Int?             @default(0) @map("item_count") // For price calculation
  isFreeClaim       Boolean          @default(false) @map("is_free_claim") // Was this claimed as a free trial?
  auctionDate       DateTime?        @map("auction_date") @db.Timestamptz(6)
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  county            County           @relation(fields: [countyId], references: [id], onDelete: Cascade)
  claims            ClaimedAuction[]

  @@index([countyId])
  @@index([externalAuctionId])
  @@map("auctions")
}

// Claimed Auctions Table (links users to their claimed auctions)
model ClaimedAuction {
  id         Int      @id @default(autoincrement()) @map("claimed_auction_id")
  userId     Int      @map("user_id")
  auctionId  Int      @unique @map("auction_id") // One user per auction
  claimedAt  DateTime @default(now()) @map("claimed_at") @db.Timestamptz(6)
  pricePaid  Decimal  @default(0.00) @map("price_paid") @db.Decimal(10, 2)

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  auction    Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([auctionId])
  @@map("claimed_auctions")
}

// Credit Transactions Table (audit trail for credits)
model CreditTransaction {
  id         Int      @id @default(autoincrement()) @map("transaction_id")
  userId     Int      @map("user_id")
  amount     Int      // positive = credit, negative = debit
  reason     String   @db.VarChar(100) // "signup_bonus", "analysis", "upgrade"
  auctionId  Int?     @map("auction_id")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("credit_transactions")
}
